upstream rankings_socket {
    server unix:/opt/rankings-sockets/rankings.sock;
}

map $http_upgrade $connection_upgrade {
	default upgrade;
	''      close;
}

server {
	listen 80;
	listen [::]:80;
	server_name yno.local;

	index index.html index.php;
	root /opt/ynohome;

	## AUTOMATED (CLIENT): Use ./scripts/add-game.sh to add a game.

	## END OF AUTOMATED CODE

	location /assets {
		sendfile           on;
		sendfile_max_chunk 1m;

		alias /opt/assets;
		try_files $uri =404;
    }

	location /badges {
		sendfile           on;
		sendfile_max_chunk 1m;

		alias /opt/badges;
		try_files $uri =404;
    }

	location /preloads {
		sendfile           on;
		sendfile_max_chunk 1m;

		alias /opt/preloads;
		try_files $uri =404;
    }

	location /data {
		sendfile           on;
		sendfile_max_chunk 1m;

		alias /opt/games;
		try_files $uri =404;
    }
}

server {
	listen 80;
	listen [::]:80;
	server_name connect.yno.local;

	# Set CORS headers for actual requests
	set $cors_origin "";
	if ($http_origin ~* ^https?://(yno\.local|connect\.yno\.local)$) {
		set $cors_origin $http_origin;
	}

	## AUTOMATED (SERVER): Use ./scripts/add-game.sh to add a game.

	## END OF AUTOMATED CODE

	location /rankings/ {
		proxy_pass http://rankings_socket/;

		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Prefix /;

		# Handle preflight OPTIONS requests
		if ($request_method = 'OPTIONS') {
			add_header 'Access-Control-Allow-Origin' $http_origin always;
			add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
			add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin' always;
			add_header 'Access-Control-Max-Age' 86400 always;
			add_header 'Content-Length' 0;
			add_header 'Content-Type' 'text/plain';
			return 204;
		}

		add_header 'Access-Control-Allow-Origin' $cors_origin always;
		add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
		add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, Origin' always;
		add_header 'Access-Control-Allow-Credentials' 'true' always;
	}
}
