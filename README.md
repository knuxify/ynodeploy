# ynodeploy

Deployment scripts for YNOProject

## Overview

This section provides an overview of the YNOProject architecture and the scripts
in this repository.

### YNOProject architecture

YNOProject consists primarily of the following components:

* [ynoengine](https://github.com/ynoproject/ynoengine) - fork of EasyRPG Player
  with multiplayer/YNO support. This is what powers the game itself, and is the
  version of EasyRPG running in the user's browser.
* [forest-orb](https://github.com/ynoproject/forest-orb) - the web client,
  or the UI wrapper around the engine that the player sees in their browser
  (providing things like the chatbox, etc.)
* [ynoserver](https://github.com/ynoproject/ynoserver) - the server for an
  individual game. Provides the backend API that the client communicates with,
  handling things like seeing other players, chat, badges, authentication, etc.
* [ynorankings](https://github.com/ynoproject/ynorankings) - one central server
  for updating the sitewide rankings data.

Other repositories that aid in these goals are:

* [ynohome](https://github.com/ynoproject/ynohome) - the homepage of ynoproject.net
  with links to all the games. Also houses the service worker for notifications.
* [ynobadges](https://github.com/ynoproject/ynobadges) - badge images and unlock
  conditions.
* Repositories with game-specific data:
  * [ynotranslations](https://github.com/ynoproject/ynotranslations) - translations
    for all the games on YNO.
  * [ynolocations](https://github.com/ynoproject/ynolocations) - mappings of map
    IDs to map names and wiki URLs.
  * [ynopreloads](https://github.com/ynoproject/ynopreloads) - lists of assets to
    preload for each room in each game

### ynodeploy layout

Files:

* `docker-compose.yml.example` (copied to `docker-compose.yml` by init script) -
  Docker Compose config that runs all the services, as well as the database
  (MariaDB), HTTP server (nginx) and PHP handler for forest-orb's index.php
  (php-fpm).
* `nginx.conf.example` (copied to `nginx.conf` by init script) - nginx (HTTP server)
  configuration.
* `schema.sql` - the database schema used to create the database tables.
* `key.bin` and `key.txt` (generated by `scripts/init.sh`) - keys for server-engine
  communication (todo: elaborate)

Directories:

* `config` - configuration files for ynorankings (`rankings.yml`)
  and ynoserver instances for each game (`gamename.yml.example`).
* `docker` - Dockerfiles for ynorankings and ynoserver, used to create
  the Docker containers (todo: these should probably be upstreamed)
* `engine` - Scripts for building ynoengine
* `games` - Base directory for games
* `repos` - Cloned source code repositories for all the components; initialized
  by `scripts/init.sh`
* `scripts` - Miscelaneous automation scripts

## Setup instructions

Prerequisites:

* Server running Linux
* `python3`, `git`, `docker` and `docker-compose` installed

### Setup for development

1. Clone the ynodeploy repository and open it:
   ```shell
   $ git clone https://github.com/knuxify/ynodeploy; cd ynodeploy
   ```
2. Run `scripts/init.sh`:
   ```shell
   $ ./scripts/init.sh
   ```
   This will download all repositories, generate configs and apply fixups needed
   to get the site up and running. After running this script, relevant repositories
   will be cloned under the `repos` subfolder (engine repositories are cloned under
   `engine`).
3. For every game you want to run, run `scripts/add-game.sh`:
   ```shell
   $ ./scripts/add-game.sh gamename path/to/game/files
   ```
   Replace `gamename` with the game's short name and `path/to/game/files` with
   the path to the extracted game (folder that contains RPG_RT.exe).
4. Compile ynoengine using the build script in the `engine` folder, and
   copy the output into `repos/forest-orb` (the client's code):
   ```shell
   $ cd engine
   $ sudo ./build.sh
   $ cp output/* ../repos/forest-orb
   $ cd ../
   ```
5. Run the container with `docker compose up -d`.
   * You may need to start the Docker service first.
   * If you get errors about insufficient permissions, use `sudo` or add your user
     to the `docker` group or equivalent for your distribution - consult your
     distro's docs.

To check the logs, run `docker compose logs`. To stop the container, run `docker compose down`.

By default, the site will be accessible through http://yno.local, with the API
exposed at http://connect.yno.local. You should add entries in your hosts file
(`/etc/hosts` on Linux) to resolve to yno.local:

```
127.0.0.1 yno.local
127.0.0.1 connect.yno.local
```

### Setup for production

1. Perform the above steps for the initial setup.
2. Run `./scripts/change-domain.sh yno.local domain.tld https` to set the target
   domain in all config files and code.
3. Set up a reverse proxy to connect to the port exposed by the container
   (todo instructions/config?)

## Maintenance

### Updating YNO server components

Run `./scripts/update-repos.sh`, which runs `git pull` in all subfolders of `repos`.
Then, shut down the containers with `docker compose down`, and restart with
`docker compose up --build` to get the containers to rebuild.

### Updating games

Extract the new game files to any directory, then run `./scripts/update-game.sh path/to/game/files gamename`
(change the arguments as needed).
